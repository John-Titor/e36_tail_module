/*
 * Emulate the E90 CAS / JBE enough for diag tools to be happy.
 *
 * Most request messages are of the form
 *
 * id       = 0x6zz     0x600 + requester ID, usually 0xf1
 * dlc      = 8
 * data[0]  = xx        responder ID
 * data[1]  = nn        request length (1-6)
 * data[2..]            request bytes
 *
 * Responses are
 *
 * id       = 0x6xx     0x600 + repsonder ID
 * data[0]  = zz        requester ID
 * data[1]  = ss        sequence number (0x10, 0x21, 0x22...)
 * data[2..6]           message data, padded with 0xff
 *
 * Responses start by echoing the request bytes, then
 * a single-byte length value containing the number of
 * additional bytes to follow. If the response extends
 * beyond the first message, the responder will wait
 * for a message with the payload <xx 30 00 01 00 00 00 00>
 * before sending the remaining message bytes.
 *
 * Since the sequence sent by the diag tool we care about
 * (BimmerGeeks ProTool) is exactly the same every time,
 * we just replay the responses it's expecting without
 * thinking too hard about it.
 */

#include <string.h>

#include <CAN1.h>

#include "timer.h"
#include "defs.h"

static struct {
    uint8_t sender;
    uint8_t message[8];
} script[] = {
    { 0xf1, {0x40, 0x02, 0x1A, 0x80, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x3C, 0x5A, 0x80, 0x00, 0x00, 0x09}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x38, 0x91, 0x16, 0xC4, 0x09, 0x06}},
    { 0x40, {0xF1, 0x22, 0xA0, 0x53, 0x41, 0x20, 0x09, 0x05}},
    { 0x40, {0xF1, 0x23, 0x20, 0x04, 0x00, 0x00, 0x00, 0x02}},
    { 0x40, {0xF1, 0x24, 0x08, 0x01, 0x03, 0x03, 0x00, 0x00}},
    { 0x40, {0xF1, 0x25, 0x00, 0x00, 0x00, 0x00, 0x06, 0x94}},
    { 0x40, {0xF1, 0x26, 0x38, 0x06, 0x30, 0x31, 0x39, 0x30}},
    { 0x40, {0xF1, 0x27, 0x30, 0x30, 0x34, 0x32, 0x4E, 0x37}},
    { 0x40, {0xF1, 0x28, 0x44, 0x30, 0x30, 0x34, 0x32, 0x4E}},
    { 0x40, {0xF1, 0x29, 0x37, 0x44, 0x46, 0x32, 0x32, 0x39}},
    { 0x40, {0xF1, 0x2A, 0x53, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x10, 0x10, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x14, 0x62, 0x10, 0x10, 0x57, 0x42}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x41, 0x50, 0x4E, 0x37, 0x33, 0x35}},
    { 0x40, {0xF1, 0x22, 0x58, 0x39, 0x41, 0x32, 0x36, 0x36}},
    { 0x40, {0xF1, 0x23, 0x33, 0x38, 0x36, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x00, 0x02, 0x41}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x34, 0x19, 0x95, 0x94, 0x3F, 0xC2}},
    { 0x40, {0xF1, 0x22, 0xE5, 0xD3, 0x41, 0x35, 0x54, 0xB2}},
    { 0x40, {0xF1, 0x23, 0x3C, 0xF7, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x01, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x01, 0x41, 0x04}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x10, 0x41, 0x04, 0x10, 0x41, 0x04}},
    { 0x40, {0xF1, 0x22, 0x10, 0x41, 0x04, 0x10, 0x41, 0x04}},
    { 0x40, {0xF1, 0x23, 0x10, 0x42, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x02, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x02, 0x11, 0x8E}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x14, 0x90, 0x55, 0x2C, 0xFA, 0x51}},
    { 0x40, {0xF1, 0x22, 0x65, 0x54, 0x65, 0x75, 0x21, 0x89}},
    { 0x40, {0xF1, 0x23, 0x55, 0xD0, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x03, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x03, 0x59, 0x15}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x58, 0x49, 0x36, 0x15, 0x41, 0x85}},
    { 0x40, {0xF1, 0x22, 0x53, 0x61, 0x75, 0x99, 0x49, 0x53}},
    { 0x40, {0xF1, 0x23, 0x21, 0x41, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x04, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x04, 0x94, 0x00}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0x40, {0xF1, 0x22, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0x40, {0xF1, 0x23, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x30, 0x01, 0x01, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x43, 0x70, 0x01, 0x01, 0x83, 0xC8}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x00, 0x28, 0x97, 0x6C, 0x00, 0x00}},
    { 0x40, {0xF1, 0x22, 0x00, 0x00, 0x00, 0x6C, 0x01, 0x6C}},
    { 0x40, {0xF1, 0x23, 0x6D, 0x6E, 0x6C, 0x6A, 0x00, 0x00}},
    { 0x40, {0xF1, 0x24, 0x00, 0x01, 0xF0, 0x00, 0x02, 0x37}},
    { 0x40, {0xF1, 0x25, 0x00, 0x4B, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x26, 0x00, 0x00, 0x00, 0x00, 0x98, 0x9E}},
    { 0x40, {0xF1, 0x27, 0x61, 0x00, 0xC1, 0x50, 0x06, 0x00}},
    { 0x40, {0xF1, 0x28, 0x1B, 0x00, 0x00, 0x00, 0x00, 0x01}},
    { 0x40, {0xF1, 0x29, 0x00, 0x00, 0x00, 0x45, 0x40, 0x21}},
    { 0x40, {0xF1, 0x2A, 0x8F, 0x36, 0x80, 0x00, 0x0D, 0xFF}},
    { 0x40, {0xF1, 0x2B, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0x40, 0x03, 0x22, 0x3F, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x13, 0x62, 0x3F, 0x00, 0x02, 0x41}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x34, 0x19, 0x95, 0x94, 0x3F, 0xC2}},
    { 0x40, {0xF1, 0x22, 0xE5, 0xD3, 0x41, 0x35, 0x54, 0xB2}},
    { 0x40, {0xF1, 0x23, 0x3C, 0xF7, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xf1, {0xEF, 0x02, 0x1A, 0x80, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x10, 0x3C, 0x5A, 0x80, 0x00, 0x00, 0x09}},
    { 0xf1, {0x40, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x40, {0xF1, 0x21, 0x38, 0x91, 0x16, 0xC4, 0x09, 0x06}},
    { 0x40, {0xF1, 0x22, 0xA0, 0x53, 0x41, 0x20, 0x09, 0x05}},
    { 0x40, {0xF1, 0x23, 0x20, 0x04, 0x00, 0x00, 0x00, 0x02}},
    { 0x40, {0xF1, 0x24, 0x08, 0x01, 0x03, 0x03, 0x00, 0x00}},
    { 0x40, {0xF1, 0x25, 0x00, 0x00, 0x00, 0x00, 0x06, 0x94}},
    { 0x40, {0xF1, 0x26, 0x38, 0x06, 0x30, 0x31, 0x39, 0x30}},
    { 0x40, {0xF1, 0x27, 0x30, 0x30, 0x34, 0x32, 0x4E, 0x37}},
    { 0x40, {0xF1, 0x28, 0x44, 0x30, 0x30, 0x34, 0x32, 0x4E}},
    { 0x40, {0xF1, 0x29, 0x37, 0x44, 0x46, 0x32, 0x32, 0x39}},
    { 0x40, {0xF1, 0x2A, 0x53, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0x00, {0xF1, 0x10, 0x1F, 0x5A, 0x80, 0x00, 0x00, 0x09}},
    { 0xf1, {0x00, 0x30, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00}},
    { 0x00, {0xF1, 0x21, 0x18, 0x75, 0x46, 0x03, 0x0A, 0x0D}},
    { 0x00, {0xF1, 0x22, 0xD0, 0x4E, 0x52, 0x20, 0x05, 0x12}},
    { 0x00, {0xF1, 0x23, 0x21, 0x09, 0x00, 0x1D, 0x88, 0x08}},
    { 0x00, {0xF1, 0x24, 0x3F, 0x00, 0x03, 0x0A, 0x00, 0x00}},
    { 0x00, {0xF1, 0x25, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF}},
    { 0xff, {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}
};

static timer_t  emulator_idle_timer;
static uint8_t  emulator_index;

// Handle receiving a new request (id = 0x6f1, dlc = 8)
void
cas_jbe_recv(uint8_t *data)
{
    // reset on idle
    if (timer_expired(emulator_idle_timer)) {
        emulator_index = 0;
    }

    // check for a message match
    if (!memcmp(&data[0], &script[emulator_index].message[0], 8)) {
        emulator_index++;

        // have to stop the scanner to prevent interference
        pt_stop(&pt_dde_scanner);

        // send responses up until the next match
        while (script[emulator_index].sender < 0xf0) {
            uint8_t ret;

            do {
                // send explicitly using buffer 1 to ensure messages are sent in order
                ret = CAN1_SendFrame(1, 
                                     0x600 | script[emulator_index].sender,
                                     DATA_FRAME,
                                     0x8,
                                     &script[emulator_index].message[0]);
            } while (ret == ERR_TXFULL);
            emulator_index++;
        }
        timer_reset(emulator_idle_timer, 500);
    } else {
        // reset on mismatch
        emulator_index = 0;
    }
}

// Send periodic Terminal Status messages
void
cas_jbe_emulator(struct pt *pt)
{
    static timer_t terminal_status_timer;

    pt_begin(pt);
    timer_register(terminal_status_timer);
    timer_register(emulator_idle_timer);

    for (;;) {
        uint8_t data[8];
        uint8_t ret;

        pt_delay(pt, terminal_status_timer, 500);

        data[0] = 0xc5;
        data[1] = 0x40;
        data[2] = 0xff;
        data[3] = 0xff;
        data[4] = 0xff;

        do {
            ret = CAN1_SendFrameExt(0x130, DATA_FRAME, 5, &data[0]);
        } while (ret == ERR_TXFULL);
    }

    pt_end(pt);
}
